name: 🤖 Auto-merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: 🔄 Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
    - name: 🔍 Fetch PR metadata
      id: metadata
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"
    
    - name: 🚀 Auto-merge safe updates
      if: |
        steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
        steps.metadata.outputs.update-type == 'version-update:semver-minor'
      run: |
        echo "✅ Safe update detected: ${{ steps.metadata.outputs.update-type }}"
        echo "📦 Package: ${{ steps.metadata.outputs.dependency-names }}"
        echo "🔄 Version: ${{ steps.metadata.outputs.previous-version }} → ${{ steps.metadata.outputs.new-version }}"
        echo "🔄 Enabling auto-merge for PR #${{ github.event.pull_request.number }}"
        
        # 启用 auto-merge，等待所有检查通过后自动合并
        gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch
        
        echo "✨ Auto-merge enabled! PR will be merged automatically when all checks pass."
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 🛡️ Auto-merge security updates
      if: contains(steps.metadata.outputs.dependency-names, 'security')
      run: |
        echo "🛡️ Security update detected - enabling auto-merge"
        echo "📦 Package: ${{ steps.metadata.outputs.dependency-names }}"
        gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch
        echo "✨ Security update will be auto-merged when CI passes!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 📝 Comment on major updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-major'
      run: |
        gh pr comment ${{ github.event.pull_request.number }} --body "🚨 **Major version update detected!**
        
        📦 **Package**: ${{ steps.metadata.outputs.dependency-names }}
        🔄 **Update**: ${{ steps.metadata.outputs.previous-version }} → ${{ steps.metadata.outputs.new-version }}
        
        **⚠️ Manual review required for major updates:**
        - Check breaking changes in changelog  
        - Verify compatibility with existing code
        - Review test coverage for new features
        - Consider impact on API consumers
        
        **To merge after review:**
        \`\`\`bash
        gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch
        \`\`\`
        
        **To close if problematic:**
        \`\`\`bash  
        gh pr close ${{ github.event.pull_request.number }}
        \`\`\`"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 单独的作业处理合并完成后的清理
  post-merge:
    name: 📝 Post-merge notifications
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.actor == 'dependabot[bot]'
    
    steps:
    - name: 🎉 Merge success notification
      run: |
        echo "🎉 Dependabot PR #${{ github.event.pull_request.number }} successfully merged!"
        echo "📦 Dependencies updated and branch cleaned up automatically."
        echo "✨ Your project is now using the latest secure versions!" 