name: ðŸ¤– Auto-merge Dependabot PRs

on:
  # åªåœ¨æ‰€æœ‰æ£€æŸ¥å®ŒæˆåŽè§¦å‘ï¼Œä¸åœ¨ PR åˆ›å»ºæ—¶è§¦å‘
  check_suite:
    types: [completed]
  status: {}
  workflow_run:
    workflows: ["ðŸ”¥ BurnDevice CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read

jobs:
  auto-merge:
    name: ðŸ”„ Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    # åªå¤„ç†æˆåŠŸçš„å·¥ä½œæµè¿è¡Œ
    if: |
      github.actor == 'dependabot[bot]' && 
      (github.event.check_suite.conclusion == 'success' || 
       github.event.workflow_run.conclusion == 'success' ||
       github.event.state == 'success')
    
    steps:
    - name: ðŸ” Find associated PR
      id: find-pr
      uses: actions/github-script@v7
      with:
        script: |
          let pr_number = null;
          let head_sha = null;
          
          // ä»Žä¸åŒäº‹ä»¶ç±»åž‹èŽ·å– SHA
          if (context.eventName === 'workflow_run') {
            head_sha = context.payload.workflow_run.head_sha;
          } else if (context.eventName === 'check_suite') {
            head_sha = context.payload.check_suite.head_sha;
          } else if (context.eventName === 'status') {
            head_sha = context.payload.sha;
          }
          
          if (!head_sha) {
            console.log('âŒ Could not determine head SHA');
            return { found: false };
          }
          
          console.log(`ðŸ” Looking for PR with head SHA: ${head_sha}`);
          
          // æŸ¥æ‰¾å¯¹åº”çš„ PR
          const { data: prs } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open'
          });
          
          const pr = prs.find(pr => pr.head.sha === head_sha);
          
          if (!pr) {
            console.log('âŒ No open PR found for this SHA');
            return { found: false };
          }
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯ Dependabot PR
          if (pr.user.login !== 'dependabot[bot]') {
            console.log(`âŒ PR is not from Dependabot (author: ${pr.user.login})`);
            return { found: false };
          }
          
          console.log(`âœ… Found Dependabot PR #${pr.number}: ${pr.title}`);
          return {
            found: true,
            number: pr.number,
            title: pr.title,
            head_sha: head_sha
          };

    - name: âœ… Verify all CI checks passed
      id: check-status
      if: steps.find-pr.outputs.result && fromJSON(steps.find-pr.outputs.result).found
      uses: actions/github-script@v7
      with:
        script: |
          const pr_info = JSON.parse(`${{ steps.find-pr.outputs.result }}`);
          const head_sha = pr_info.head_sha;
          
          console.log(`ðŸ” Checking CI status for SHA: ${head_sha}`);
          
          // èŽ·å–æ‰€æœ‰æ£€æŸ¥è¿è¡Œ
          const { data: checkRuns } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: head_sha
          });
          
          // èŽ·å–çŠ¶æ€æ£€æŸ¥
          const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: head_sha
          });
          
          // å®šä¹‰å¿…éœ€çš„æ£€æŸ¥
          const requiredChecks = [
            'ðŸ” Code Quality',
            'ðŸ›¡ï¸ Security Scan',
            'ðŸ§ª Test',
            'ðŸ—ï¸ Build'
          ];
          
          let allChecksPassed = true;
          let checkResults = [];
          
          // æ£€æŸ¥æ¯ä¸ªå¿…éœ€çš„æ£€æŸ¥
          for (const checkName of requiredChecks) {
            const checkRun = checkRuns.check_runs.find(run => run.name === checkName);
            
            if (!checkRun) {
              console.log(`âŒ Required check '${checkName}' not found`);
              allChecksPassed = false;
              checkResults.push(`âŒ ${checkName}: Not found`);
              continue;
            }
            
            if (checkRun.conclusion !== 'success') {
              console.log(`âŒ Check '${checkName}' failed: ${checkRun.conclusion}`);
              allChecksPassed = false;
              checkResults.push(`âŒ ${checkName}: ${checkRun.conclusion}`);
            } else {
              console.log(`âœ… Check '${checkName}' passed`);
              checkResults.push(`âœ… ${checkName}: success`);
            }
          }
          
          // æ£€æŸ¥çŠ¶æ€æ£€æŸ¥
          const failedStatuses = statuses.filter(status => status.state === 'failure');
          if (failedStatuses.length > 0) {
            console.log(`âŒ Found ${failedStatuses.length} failed status checks`);
            allChecksPassed = false;
            failedStatuses.forEach(status => {
              checkResults.push(`âŒ ${status.context}: ${status.state}`);
            });
          }
          
          console.log(`ðŸŽ¯ Overall CI status: ${allChecksPassed ? 'PASSED' : 'FAILED'}`);
          
          return {
            all_passed: allChecksPassed,
            check_results: checkResults,
            pr_number: pr_info.number
          };

    - name: ðŸ” Fetch PR metadata
      id: metadata
      if: |
        steps.find-pr.outputs.result && 
        fromJSON(steps.find-pr.outputs.result).found && 
        fromJSON(steps.check-status.outputs.result).all_passed
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    - name: ðŸš€ Auto-merge safe updates
      if: |
        steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
        steps.metadata.outputs.update-type == 'version-update:semver-minor'
      run: |
        PR_NUMBER="${{ fromJSON(steps.check-status.outputs.result).pr_number }}"
        
        echo "ðŸŽ‰ All CI checks passed! Proceeding with auto-merge..."
        echo "âœ… Safe update detected: ${{ steps.metadata.outputs.update-type }}"
        echo "ðŸ“¦ Package: ${{ steps.metadata.outputs.dependency-names }}"
        echo "ðŸ”„ Version: ${{ steps.metadata.outputs.previous-version }} â†’ ${{ steps.metadata.outputs.new-version }}"
        
        # ç›´æŽ¥åˆå¹¶ï¼ˆä¸ä½¿ç”¨ --autoï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»éªŒè¯äº†æ‰€æœ‰æ£€æŸ¥ï¼‰
        gh pr merge ${PR_NUMBER} --squash --delete-branch
        
        echo "ðŸŽ‰ PR #${PR_NUMBER} merged successfully and branch deleted!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ›¡ï¸ Auto-merge security updates
      if: |
        contains(steps.metadata.outputs.update-type, 'security') ||
        contains(steps.metadata.outputs.dependency-names, 'security')
      run: |
        PR_NUMBER="${{ fromJSON(steps.check-status.outputs.result).pr_number }}"
        
        echo "ðŸ›¡ï¸ Security update detected - merging immediately!"
        echo "ðŸ“¦ Package: ${{ steps.metadata.outputs.dependency-names }}"
        
        # ç›´æŽ¥åˆå¹¶å®‰å…¨æ›´æ–°
        gh pr merge ${PR_NUMBER} --squash --delete-branch
        
        echo "ðŸŽ‰ Security update merged and branch deleted!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“ Comment on major updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-major'
      run: |
        PR_NUMBER="${{ fromJSON(steps.check-status.outputs.result).pr_number }}"
        CI_STATUS="${{ fromJSON(steps.check-status.outputs.result).all_passed }}"
        
        if [ "$CI_STATUS" = "true" ]; then
          STATUS_MSG="âœ… **All CI checks passed!** Ready for manual review and merge."
          ACTION_MSG="This PR is ready to merge after manual review."
        else
          STATUS_MSG="âŒ **Some CI checks failed.** Please review and fix issues first."
          ACTION_MSG="Fix CI issues before proceeding with merge."
        fi
        
        gh pr comment ${PR_NUMBER} --body "ðŸš¨ **Major version update detected!**
        
        ðŸ“¦ **Package**: ${{ steps.metadata.outputs.dependency-names }}
        ðŸ”„ **Update**: ${{ steps.metadata.outputs.previous-version }} â†’ ${{ steps.metadata.outputs.new-version }}
        
        ${STATUS_MSG}
        
        **âš ï¸ Manual review required for major updates:**
        - Check breaking changes in changelog  
        - Verify compatibility with existing code
        - Review test coverage for new features
        - Consider impact on API consumers
        
        **CI Check Results:**
        $(echo '${{ steps.check-status.outputs.result }}' | jq -r '.check_results[]' 2>/dev/null || echo 'CI status check failed')
        
        **${ACTION_MSG}**
        
        **To merge after review:**
        \`\`\`bash
        gh pr merge ${PR_NUMBER} --squash --delete-branch
        \`\`\`"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: âŒ Comment on CI failures
      if: |
        steps.find-pr.outputs.result && 
        fromJSON(steps.find-pr.outputs.result).found && 
        steps.check-status.outputs.result &&
        !fromJSON(steps.check-status.outputs.result).all_passed &&
        steps.metadata.outputs.update-type != 'version-update:semver-major'
      run: |
        PR_NUMBER="${{ fromJSON(steps.check-status.outputs.result).pr_number }}"
        
        gh pr comment ${PR_NUMBER} --body "âŒ **Auto-merge blocked - CI checks failed**
        
        ðŸ“¦ **Package**: ${{ steps.metadata.outputs.dependency-names || 'Unknown' }}
        ðŸ”„ **Update Type**: ${{ steps.metadata.outputs.update-type || 'Unknown' }}
        
        **Failed Checks:**
        $(echo '${{ steps.check-status.outputs.result }}' | jq -r '.check_results[] | select(startswith("âŒ"))' 2>/dev/null || echo 'Failed to parse check results')
        
        **This PR will be auto-merged once all CI checks pass.** âœ¨
        
        **Common fixes:**
        1. Check CI logs for specific errors
        2. Rebase if there are conflicts: \`@dependabot rebase\`
        3. If issues persist, manual intervention may be needed
        
        **Manual merge after fixes:**
        \`\`\`bash
        gh pr merge ${PR_NUMBER} --squash --delete-branch
        \`\`\`"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
