name: ğŸ¤– Auto-merge Dependabot PRs

on:
  # åœ¨ CI å·¥ä½œæµå®Œæˆåè§¦å‘ï¼ŒåŒ…æ‹¬ PR åˆ†æ”¯
  workflow_run:
    workflows: ["ğŸ”¥ BurnDevice CI"]
    types: [completed]
    # ç§»é™¤ branches é™åˆ¶ï¼Œè®©å®ƒå¯ä»¥å“åº”æ‰€æœ‰åˆ†æ”¯çš„ CI
  
  # ä¹Ÿåœ¨ PR çš„çŠ¶æ€æ£€æŸ¥å®Œæˆæ—¶è§¦å‘
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read

jobs:
  auto-merge:
    name: ğŸ”„ Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    # åªå¤„ç†æˆåŠŸçš„å·¥ä½œæµè¿è¡Œ
    if: |
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run != null) ||
      (github.event.check_suite.conclusion == 'success' && github.event.check_suite != null)
    
    steps:
    - name: ğŸ” Find associated PR
      id: find-pr
      uses: actions/github-script@v7
      with:
        script: |
          let head_sha = null;
          
          // ä»ä¸åŒäº‹ä»¶ç±»å‹è·å– SHA
          if (context.eventName === 'workflow_run' && context.payload.workflow_run) {
            head_sha = context.payload.workflow_run.head_sha;
            console.log(`ğŸ“‹ Workflow run event - SHA: ${head_sha}`);
          } else if (context.eventName === 'check_suite' && context.payload.check_suite) {
            head_sha = context.payload.check_suite.head_sha;
            console.log(`âœ… Check suite event - SHA: ${head_sha}`);
          }
          
          if (!head_sha) {
            console.log('âŒ Could not determine head SHA from event');
            return { found: false, reason: 'No head SHA found' };
          }
          
          console.log(`ğŸ” Looking for PR with head SHA: ${head_sha}`);
          
          // æŸ¥æ‰¾å¯¹åº”çš„ PR
          const { data: prs } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open'
          });
          
          console.log(`ğŸ“Š Found ${prs.length} open PRs`);
          
          const pr = prs.find(pr => pr.head.sha === head_sha);
          
          if (!pr) {
            console.log('âŒ No open PR found for this SHA');
            console.log('ğŸ” Available PR SHAs:');
            prs.forEach(p => console.log(`  - PR #${p.number}: ${p.head.sha} (${p.user.login})`));
            return { found: false, reason: 'No matching PR found' };
          }
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯ Dependabot PR
          if (pr.user.login !== 'dependabot[bot]') {
            console.log(`âŒ PR is not from Dependabot (author: ${pr.user.login})`);
            return { found: false, reason: 'Not a Dependabot PR' };
          }
          
          console.log(`âœ… Found Dependabot PR #${pr.number}: ${pr.title}`);
          return {
            found: true,
            number: pr.number,
            title: pr.title,
            mergeable: pr.mergeable,
            mergeable_state: pr.mergeable_state
          };

    - name: ğŸ” Fetch PR metadata
      id: metadata
      if: steps.find-pr.outputs.result && fromJSON(steps.find-pr.outputs.result).found
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    - name: âœ… Verify PR is ready to merge
      id: check-mergeable
      if: steps.find-pr.outputs.result && fromJSON(steps.find-pr.outputs.result).found
      uses: actions/github-script@v7
      with:
        script: |
          const pr_info = JSON.parse(`${{ steps.find-pr.outputs.result }}`);
          const pr_number = pr_info.number;
          
          // è·å–æœ€æ–°çš„ PR çŠ¶æ€
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr_number
          });
          
          console.log(`ğŸ“Š PR #${pr_number} status:`);
          console.log(`  - State: ${pr.state}`);
          console.log(`  - Mergeable: ${pr.mergeable}`);
          console.log(`  - Mergeable state: ${pr.mergeable_state}`);
          
          // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆå¹¶
          const canMerge = pr.state === 'open' && 
                          pr.mergeable === true && 
                          pr.mergeable_state === 'clean';
          
          console.log(`ğŸ¯ Can merge: ${canMerge}`);
          
          return {
            can_merge: canMerge,
            pr_number: pr_number,
            state: pr.state,
            mergeable: pr.mergeable,
            mergeable_state: pr.mergeable_state
          };

    - name: ğŸš€ Auto-merge safe updates
      if: |
        steps.check-mergeable.outputs.result && 
        fromJSON(steps.check-mergeable.outputs.result).can_merge &&
        (steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
         steps.metadata.outputs.update-type == 'version-update:semver-minor')
      run: |
        PR_NUMBER="${{ fromJSON(steps.check-mergeable.outputs.result).pr_number }}"
        
        echo "ğŸ‰ All checks passed! Proceeding with auto-merge..."
        echo "âœ… Safe update detected: ${{ steps.metadata.outputs.update-type }}"
        echo "ğŸ“¦ Package: ${{ steps.metadata.outputs.dependency-names }}"
        echo "ğŸ”„ Version: ${{ steps.metadata.outputs.previous-version }} â†’ ${{ steps.metadata.outputs.new-version }}"
        
        # åˆå¹¶ PR
        gh pr merge ${PR_NUMBER} --squash --delete-branch
        
        echo "ğŸ‰ PR #${PR_NUMBER} merged successfully and branch deleted!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ›¡ï¸ Auto-merge security updates
      if: |
        steps.check-mergeable.outputs.result && 
        fromJSON(steps.check-mergeable.outputs.result).can_merge &&
        (contains(steps.metadata.outputs.update-type, 'security') ||
         contains(steps.metadata.outputs.dependency-names, 'security'))
      run: |
        PR_NUMBER="${{ fromJSON(steps.check-mergeable.outputs.result).pr_number }}"
        
        echo "ğŸ›¡ï¸ Security update detected - merging immediately!"
        echo "ğŸ“¦ Package: ${{ steps.metadata.outputs.dependency-names }}"
        
        # åˆå¹¶å®‰å…¨æ›´æ–°
        gh pr merge ${PR_NUMBER} --squash --delete-branch
        
        echo "ğŸ‰ Security update merged and branch deleted!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“ Comment on major updates
      if: |
        steps.metadata.outputs.update-type == 'version-update:semver-major' &&
        steps.check-mergeable.outputs.result
      run: |
        PR_NUMBER="${{ fromJSON(steps.check-mergeable.outputs.result).pr_number }}"
        CAN_MERGE="${{ fromJSON(steps.check-mergeable.outputs.result).can_merge }}"
        
        if [ "$CAN_MERGE" = "true" ]; then
          STATUS_MSG="âœ… **All CI checks passed!** Ready for manual review and merge."
          ACTION_MSG="This PR is ready to merge after manual review."
        else
          STATUS_MSG="âŒ **PR is not ready to merge.** Please check CI status and conflicts."
          ACTION_MSG="Fix any issues before proceeding with merge."
        fi
        
        gh pr comment ${PR_NUMBER} --body "ğŸš¨ **Major version update detected!**
        
        ğŸ“¦ **Package**: ${{ steps.metadata.outputs.dependency-names }}
        ğŸ”„ **Update**: ${{ steps.metadata.outputs.previous-version }} â†’ ${{ steps.metadata.outputs.new-version }}
        
        ${STATUS_MSG}
        
        **âš ï¸ Manual review required for major updates:**
        - Check breaking changes in changelog  
        - Verify compatibility with existing code
        - Review test coverage for new features
        - Consider impact on API consumers
        
        **${ACTION_MSG}**
        
        **To merge after review:**
        \`\`\`bash
        gh pr merge ${PR_NUMBER} --squash --delete-branch
        \`\`\`"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: âŒ Comment on unmergeable PRs
      if: |
        steps.find-pr.outputs.result && 
        fromJSON(steps.find-pr.outputs.result).found &&
        steps.check-mergeable.outputs.result &&
        !fromJSON(steps.check-mergeable.outputs.result).can_merge &&
        steps.metadata.outputs.update-type != 'version-update:semver-major'
      run: |
        PR_NUMBER="${{ fromJSON(steps.check-mergeable.outputs.result).pr_number }}"
        MERGEABLE_STATE="${{ fromJSON(steps.check-mergeable.outputs.result).mergeable_state }}"
        
        gh pr comment ${PR_NUMBER} --body "âŒ **Auto-merge blocked - PR not ready**
        
        ğŸ“¦ **Package**: ${{ steps.metadata.outputs.dependency-names || 'Unknown' }}
        ğŸ”„ **Update Type**: ${{ steps.metadata.outputs.update-type || 'Unknown' }}
        ğŸ“Š **Status**: ${MERGEABLE_STATE}
        
        **This PR cannot be auto-merged because:**
        - CI checks may still be running or have failed
        - There may be merge conflicts
        - The PR may be in draft state
        
        **This PR will be auto-merged once it becomes mergeable.** âœ¨
        
        **Common fixes:**
        1. Wait for CI checks to complete
        2. Resolve merge conflicts: \`@dependabot rebase\`
        3. Check if PR is in draft mode
        
        **Manual merge when ready:**
        \`\`\`bash
        gh pr merge ${PR_NUMBER} --squash --delete-branch
        \`\`\`"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“‹ Debug information
      if: steps.find-pr.outputs.result && !fromJSON(steps.find-pr.outputs.result).found
      run: |
        echo "ğŸ› Debug: Auto-merge workflow triggered but no Dependabot PR found"
        echo "ğŸ“‹ Event: ${{ github.event_name }}"
        echo "ğŸ” Reason: ${{ fromJSON(steps.find-pr.outputs.result).reason }}"
        
        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          echo "ğŸ“Š Workflow run details:"
          echo "  - Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "  - Head SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "  - Head branch: ${{ github.event.workflow_run.head_branch }}"
        elif [ "${{ github.event_name }}" = "check_suite" ]; then
          echo "ğŸ“Š Check suite details:"
          echo "  - Conclusion: ${{ github.event.check_suite.conclusion }}"
          echo "  - Head SHA: ${{ github.event.check_suite.head_sha }}"
          echo "  - Head branch: ${{ github.event.check_suite.head_branch }}"
        fi
