name: ğŸ¤– Auto-merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: ğŸ”„ Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
    - name: ğŸ” Fetch PR metadata
      id: metadata
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"
    
    - name: ğŸš€ Auto-merge safe updates
      if: |
        steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
        steps.metadata.outputs.update-type == 'version-update:semver-minor'
      run: |
        echo "âœ… Safe update detected: ${{ steps.metadata.outputs.update-type }}"
        echo "ğŸ“¦ Package: ${{ steps.metadata.outputs.dependency-names }}"
        echo "ğŸ”„ Version: ${{ steps.metadata.outputs.previous-version }} â†’ ${{ steps.metadata.outputs.new-version }}"
        echo "ğŸ”„ Enabling auto-merge for PR #${{ github.event.pull_request.number }}"
        
        # å¯ç”¨ auto-mergeï¼Œç­‰å¾…æ‰€æœ‰æ£€æŸ¥é€šè¿‡åè‡ªåŠ¨åˆå¹¶
        gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch
        
        echo "âœ¨ Auto-merge enabled! PR will be merged automatically when all checks pass."
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ›¡ï¸ Auto-merge security updates
      if: contains(steps.metadata.outputs.dependency-names, 'security')
      run: |
        echo "ğŸ›¡ï¸ Security update detected - enabling auto-merge"
        echo "ğŸ“¦ Package: ${{ steps.metadata.outputs.dependency-names }}"
        gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch
        echo "âœ¨ Security update will be auto-merged when CI passes!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“ Comment on major updates
      if: steps.metadata.outputs.update-type == 'version-update:semver-major'
      run: |
        gh pr comment ${{ github.event.pull_request.number }} --body "ğŸš¨ **Major version update detected!**
        
        ğŸ“¦ **Package**: ${{ steps.metadata.outputs.dependency-names }}
        ğŸ”„ **Update**: ${{ steps.metadata.outputs.previous-version }} â†’ ${{ steps.metadata.outputs.new-version }}
        
        **âš ï¸ Manual review required for major updates:**
        - Check breaking changes in changelog  
        - Verify compatibility with existing code
        - Review test coverage for new features
        - Consider impact on API consumers
        
        **To merge after review:**
        \`\`\`bash
        gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch
        \`\`\`
        
        **To close if problematic:**
        \`\`\`bash  
        gh pr close ${{ github.event.pull_request.number }}
        \`\`\`"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å•ç‹¬çš„ä½œä¸šå¤„ç†åˆå¹¶å®Œæˆåçš„æ¸…ç†
  post-merge:
    name: ğŸ“ Post-merge notifications
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.actor == 'dependabot[bot]'
    
    steps:
    - name: ğŸ‰ Merge success notification
      run: |
        echo "ğŸ‰ Dependabot PR #${{ github.event.pull_request.number }} successfully merged!"
        echo "ğŸ“¦ Dependencies updated and branch cleaned up automatically."
        echo "âœ¨ Your project is now using the latest secure versions!" 